name: Release
on:
  push:
    tags:
      - "v*.*.*"
permissions:
  contents: read
jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Go
      uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
      with:
        go-version: '1.22'

    - name: Get Build Vars
      id: vars
      run: |
        echo "PKG=github.com/Michad/tilegroxy" >> $GITHUB_OUTPUT
        echo "VERSION=$(git describe --tag --abbrev=0 --dirty)" >> $GITHUB_OUTPUT
        echo "REF=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "DATE=$(date -Iseconds --u)" >> $GITHUB_OUTPUT

    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0
      id: import_gpg
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}

    - name: Release
      uses: goreleaser/goreleaser-action@286f3b13b1b49da4ac219696163fb8c1c93e1200 # v6.0.0
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        distribution: goreleaser
        version: "~> v2"
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
        PKG: ${{ steps.vars.outputs.PKG }}
        VERSION: ${{ steps.vars.outputs.VERSION }}
        REF: ${{ steps.vars.outputs.REF }}
        DATE: ${{ steps.vars.outputs.DATE }}
  