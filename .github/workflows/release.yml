name: Release
on:
  push:
    tags:
      - "v*.*.*"
permissions:
  contents: read
jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Go
      uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
      with:
        go-version-file: 'go.mod'

    - name: Get Build Vars
      id: vars
      run: |
        echo "PKG=github.com/Michad/tilegroxy" >> $GITHUB_OUTPUT
        echo "VERSION=$(git describe --tag --abbrev=0 --dirty)" >> $GITHUB_OUTPUT
        echo "REF=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "DATE=$(date -Iseconds --u)" >> $GITHUB_OUTPUT

    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
      id: import_gpg
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}

    - name: Release
      uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        distribution: goreleaser
        version: "~> v2"
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
        PKG: ${{ steps.vars.outputs.PKG }}
        VERSION: ${{ steps.vars.outputs.VERSION }}
        REF: ${{ steps.vars.outputs.REF }}
        DATE: ${{ steps.vars.outputs.DATE }}
  